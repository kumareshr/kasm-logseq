#!/bin/bash

USERNAME=$(whoami)

# Fix ownership
if [ "$USERNAME" != "abc" ]; then
  echo "$USERNAME is not abc, changing ownership of /opt/logseq to $(id -u):$(id -g)"
  sudo lsiown -R $(id -u):$(id -g) /opt/logseq
  echo "current ownership:" && ls -ld /opt/logseq
fi

# Export DISPLAY
export DISPLAY=:1

# Wait until X server is *fully* ready
echo "Waiting for X to be fully ready..."
RETRIES=30
until xset q &>/dev/null || [ $RETRIES -eq 0 ]; do
  echo "Waiting for X... $RETRIES"
  sleep 1
  RETRIES=$((RETRIES-1))
done

if [ $RETRIES -eq 0 ]; then
  echo "X server did not become ready in time"
  exit 1
fi

echo "X is ready. Launching Logseq..."
logseq &
echo "Logseq started"
